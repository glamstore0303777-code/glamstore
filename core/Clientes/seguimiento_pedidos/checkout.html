{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Checkout — GlamStore</title>
  <link rel="icon" href="{% static 'img/logoglam.png' %}">
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Comic Neue', cursive, Arial, sans-serif;
      background-image: 
        linear-gradient(135deg, rgba(243, 232, 255, 0.7) 0%, rgba(233, 213, 255, 0.7) 100%),
        url('/static/img/fondo.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-color: #f3e8ff;
      color: #1a1a1a;
      scroll-behavior: smooth;
    }

    .sidebar {
      background: linear-gradient(180deg, #faf5ff 0%, #f3e8ff 100%);
      padding: 2rem;
      width: 240px;
      height: 100vh;
      position: fixed;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      border-right: 2px solid #d8b4fe;
      box-shadow: 4px 0 20px rgba(168, 85, 247, 0.15);
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar img.logo {
      width: 80px;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease;
    }

    .sidebar img.logo:hover {
      transform: scale(1.05);
    }

    .sidebar h1 {
      color: #6b21a8;
      font-size: 1.3rem;
      margin: 0 0 0.5rem 0;
      font-weight: 700;
      letter-spacing: 0.5px;
      line-height: 1.3;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .sidebar a h1 {
      transition: color 0.3s ease;
    }

    .sidebar a:hover h1 {
      color: #7c3aed;
    }

    .sidebar p {
      color: #9333ea;
      font-size: 0.85rem;
      margin: 0 0 2rem 0;
      font-weight: 400;
      font-style: italic;
    }

    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0 0 2rem 0;
      flex: 1;
      width: 100%;
    }

    .sidebar nav li {
      margin-bottom: 0.6rem;
    }

    .sidebar nav a {
      display: block;
      padding: 0.75rem 1.2rem;
      text-decoration: none;
      color: #1a1a1a;
      font-weight: 500;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      position: relative;
      overflow: hidden;
    }

    .sidebar nav a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      transition: width 0.3s ease;
      z-index: -1;
    }

    .sidebar nav a:hover,
    .sidebar nav a.active {
      color: #ffffff;
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    .sidebar nav a:hover::before,
    .sidebar nav a.active::before {
      width: 100%;
    }

    .main-content { margin-left: 240px; padding: 2rem; width: calc(100% - 240px); min-height: 100vh; }
    h2.titulo-checkout { font-size: 2.2rem; color: #1a1a1a; border-bottom: 3px solid #a855f7; padding-bottom: 0.8rem; margin-bottom: 2rem; font-weight: 700; letter-spacing: 1px; }
    .checkout-container { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-between; }
    .formulario { flex: 1 1 55%; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 2rem; border-radius: 20px; box-shadow: 0 6px 20px rgba(168, 85, 247, 0.15); border: 2px solid #e9d5ff; }
    .resumen { flex: 1 1 40%; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 2rem; border-radius: 20px; position: sticky; top: 2rem; align-self: flex-start; box-shadow: 0 6px 20px rgba(168, 85, 247, 0.15); border: 2px solid #e9d5ff; }
    h2, h3 { font-size: 1.8rem; color: #7c3aed; margin-bottom: 1rem; font-weight: 600; }
    h3 { font-size: 1.4rem; color: #7c3aed; margin-top: 2rem; }
    form label { display: block; margin-top: 1rem; font-weight: 500; color: #1a1a1a; }
    form input, form select { width: 100%; padding: 0.6rem; margin-top: 0.4rem; border-radius: 8px; border: 1px solid #e9d5ff; background-color: #ffffff; color: #1a1a1a; font-weight: 500; }
    form input:focus, form select:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1); }
    input[type="radio"], input[type="checkbox"] { accent-color: #a855f7; margin-right: 0.5rem; }
    .btn-finalizar { margin-top: 2rem; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; padding: 0.8rem 1.6rem; border-radius: 12px; font-weight: bold; font-size: 1rem; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }
    .btn-finalizar:hover { background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(168, 85, 247, 0.4); }
    .btn-volver { display: inline-block; margin-top: 1rem; color: #7c3aed; text-decoration: none; font-weight: bold; font-size: 1rem; }
    .btn-volver:hover { color: #6b21a8; text-decoration: underline; }
    .metodos-pago { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
    .metodo-pago-opcion { background: #ffffff; padding: 1rem; border-radius: 12px; border: 2px solid #e9d5ff; cursor: pointer; transition: all 0.3s; }
    .metodo-pago-opcion:hover { border-color: #c084fc; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15); }
    .metodo-pago-opcion.seleccionado { border-color: #a855f7; box-shadow: 0 0 12px rgba(168, 85, 247, 0.3); background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); }
    .metodo-pago-opcion label { display: flex; align-items: center; gap: 0.8rem; font-weight: 500; color: #1a1a1a; }
    .pago-detalles { display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fff; border-radius: 12px; border: 1px solid #e9d5ff; }
    .pago-detalles h4 { color: #7c3aed; margin-bottom: 1rem; font-weight: 600; }
    .pago-detalles p { margin-bottom: 1rem; color: #1a1a1a; }
    .pago-detalles strong { color: #1a1a1a; }
    .precio-resumen::first-letter, .precio-cell::first-letter { color: #7c3aed; }
    @media (max-width: 768px) { .checkout-container { flex-direction: column; } .formulario, .resumen { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <img src="{% static 'img/logoglam.png' %}" alt="Logo GlamStore" class="logo">
    {% if request.session.usuario_nombre %}
    <a href="{% url 'perfil' %}" style="text-decoration: none; color: inherit;">
      <h1>¡Hola, {{ request.session.usuario_nombre }}!</h1>
    </a>
    <p>Qué bueno verte de nuevo</p>
    {% else %}
    <h1>Bienvenida a GlamStore</h1>
    <p>Tu espacio de moda, color y alegría</p>
    {% endif %}
    <nav>
      <ul>
        <li><a href="{% url 'tienda' %}">← Volver a Tienda</a></li>
        {% if request.session.usuario_nombre %}
        <li><a href="{% url 'perfil' %}">Mi Perfil</a></li>
        {% else %}
        <li><a href="{% url 'login' %}">Iniciar Sesión</a></li>
        {% endif %}
        <li><a href="{% url 'ver_carrito' %}">Carrito</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <h2 class="titulo-checkout">Finalizar Compra</h2>

    <div class="checkout-container">
      <section class="formulario">
        <form method="POST" action="{% url 'simular_pago' %}">
          {% csrf_token %}

          <h3>1. DATOS PERSONALES</h3>
          
          {% if usuario_logueado and cliente_datos %}
          <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #4caf50;">
            <h4 style="color: #2e7d32; margin-bottom: 1rem;">✅ Datos de tu cuenta</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div><strong style="color: #2e7d32;">Nombre:</strong><br><span>{{ cliente_datos.nombre }}</span></div>
              <div><strong style="color: #2e7d32;">Email:</strong><br><span>{{ cliente_datos.email }}</span></div>
              <div><strong style="color: #2e7d32;">Cédula:</strong><br><span>{{ cliente_datos.cedula|default:"No registrada" }}</span></div>
              <div><strong style="color: #2e7d32;">Teléfono:</strong><br><span>{{ cliente_datos.telefono|default:"No registrado" }}</span></div>
            </div>
          </div>
          
          <input type="hidden" name="correo" value="{{ cliente_datos.email }}">
          <input type="hidden" name="nombre" value="{{ cliente_datos.nombre|slice:':20' }}">
          <input type="hidden" name="apellidos" value="{{ cliente_datos.nombre|slice:'20:' }}">
          <input type="hidden" name="documento" value="{{ cliente_datos.cedula|default:'' }}">
          <input type="hidden" name="telefono" value="{{ cliente_datos.telefono|default:'' }}">
          <input type="hidden" name="tipo_documento" value="CC">
          
          {% else %}
          <label>Correo</label>
          <input type="email" name="correo" required>

          <label>Nombre</label>
          <input type="text" name="nombre" required>

          <label>Apellidos</label>
          <input type="text" name="apellidos" required>

          <label>Número de Cédula</label>
          <input type="text" name="documento" required placeholder="Ingresa tu número de cédula">

          <label>Teléfono / Móvil</label>
          <input type="tel" name="telefono" required>
          
          <input type="hidden" name="tipo_documento" value="CC">
          {% endif %}

          <h3>2. ENTREGA</h3>
          
          <label>Departamento</label>
          <select name="departamento" id="departamento" required>
            <option value="">Selecciona tu departamento</option>
            <option value="Cundinamarca">Cundinamarca</option>
            <option value="Bogotá D.C.">Bogotá D.C.</option>
          </select>

          <label>Municipio</label>
          <select name="municipio" id="municipio" required>
            <option value="">Primero selecciona un departamento</option>
          </select>

          <label id="label-comuna">Comuna/Localidad</label>
          <select name="comuna" id="comuna" required>
            <option value="">Primero selecciona un municipio</option>
          </select>

          <label>Dirección</label>
          <input type="text" name="direccion" required placeholder="Ej: Calle 123 # 45-67" {% if cliente_datos.direccion %}value="{{ cliente_datos.direccion }}"{% endif %}>

          <label>Información adicional</label>
          <input type="text" name="info_adicional" placeholder="Ej: Apartamento 301, Torre B">

          <label>Nombre de quien recibe</label>
          <input type="text" name="nombre_receptor" required {% if cliente_datos.nombre %}value="{{ cliente_datos.nombre }}"{% endif %}>

          <h3>3. MÉTODO DE ENTREGA</h3>

          <label><input type="radio" name="pago_envio" value="ahora" checked> Pagar envío ahora (Total + $10.000)</label>
          <label><input type="radio" name="pago_envio" value="contra_entrega"> Pagar envío contra entrega</label>

          <h3>4. PAGO</h3>
          <div class="metodos-pago">
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="nequi_daviplata" required> Pagar con Nequi / Daviplata</label>
            </div>
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="consignacion"> Consignación Bancaria</label>
            </div>
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="efecty"> Pago en Efecty</label>
            </div>
          </div>

          <div id="detalles_nequi_daviplata" class="pago-detalles">
            <h4>Pagar con Nequi / Daviplata</h4>
            <label for="celular_pago">Número de celular:</label>
            <input type="tel" id="celular_pago" name="celular_pago" placeholder="Tu número de Nequi o Daviplata">
            <label for="clave_dinamica">Clave dinámica:</label>
            <input type="text" id="clave_dinamica" name="clave_dinamica" placeholder="Ingresa tu clave dinámica">
          </div>

          <div id="detalles_consignacion" class="pago-detalles">
            <h4>Pagar con Consignación Bancaria</h4>
            <p>Realiza la transferencia a la siguiente cuenta:</p>
            <p><strong>Cuenta de Ahorros Bancolombia:</strong> 123-456789-00 a nombre de Glam Store.</p>
            <label for="referencia_pago">Código de referencia de pago:</label>
            <input type="text" id="referencia_pago" name="referencia_pago" placeholder="Ingresa el número de referencia">
          </div>

          <div id="detalles_efecty" class="pago-detalles">
            <h4>Pagar en Efecty</h4>
            <p>Dirígete a tu punto Efecty más cercano y presenta el siguiente código:</p>
            <p><strong>Código de pago:</strong> 987-654-321</p>
          </div>

          <button type="submit" class="btn-finalizar" id="btn-finalizar">Continuar y hacer el pago</button>
        </form>
      </section>

      <section class="resumen">
        <h2 style="color: #1a1a1a;">RESUMEN DE LA COMPRA</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.9rem;">
          <thead>
            <tr style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-bottom: 2px solid #d8b4fe;">
              <th style="padding: 0.8rem; text-align: left; color: #7c3aed; font-weight: bold;">Producto</th>
              <th style="padding: 0.8rem; text-align: center; color: #7c3aed; font-weight: bold;">Cantidad</th>
              <th style="padding: 0.8rem; text-align: right; color: #7c3aed; font-weight: bold;">Precio Unitario</th>
              <th style="padding: 0.8rem; text-align: right; color: #7c3aed; font-weight: bold;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for item in carrito %}
            <tr style="border-bottom: 1px solid #e9d5ff;">
              <td style="padding: 0.8rem; color: #1a1a1a;">{{ item.producto.nombreProducto }}</td>
              <td style="padding: 0.8rem; text-align: center; color: #1a1a1a;">{{ item.cantidad }}</td>
              <td class="precio-cell" style="padding: 0.8rem; text-align: right; color: #1a1a1a; font-weight: 600;">${{ item.producto.precio_venta|floatformat:0 }}</td>
              <td class="precio-cell" style="padding: 0.8rem; text-align: right; color: #1a1a1a; font-weight: bold;">${{ item.subtotal|floatformat:0 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="background: #ffffff; padding: 1.5rem; border-radius: 12px; border: 2px solid #e9d5ff;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
            <span style="color: #1a1a1a;">Sub Total:</span>
            <strong class="precio-resumen" style="color: #1a1a1a; font-weight: 600;" id="base-liquida-valor">${{ total|floatformat:0 }}</strong>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
            <span style="color: #1a1a1a;">IVA (19%):</span>
            <strong class="precio-resumen" style="color: #1a1a1a; font-weight: 600;" id="iva-valor-resumen">$0</strong>
          </div>
          
          <div id="costo-envio-resumen-div" style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
            <span style="color: #1a1a1a;">Envío:</span>
            <strong class="precio-resumen" style="color: #1a1a1a; font-weight: 600;">$10.000</strong>
          </div>
          
          <div style="display: flex; justify-content: space-between; padding-top: 0.8rem;">
            <span style="font-size: 1.1rem; font-weight: bold; color: #1a1a1a;">Total del Pedido:</span>
            <strong class="precio-resumen" style="font-size: 1.2rem; color: #1a1a1a; font-weight: 700;" id="total-valor-resumen">${{ total|add:10000|floatformat:0 }}</strong>
          </div>
        </div>

        <a href="{% url 'tienda' %}" class="btn-volver">← Seguir comprando</a>
      </section>
    </div>

    <footer class="pie" style="margin-top: 3rem; text-align: center; color: #888;">
      <p>&copy; 2025 GlamStore — Belleza con estilo</p>
    </footer>
  </main>
</html>

  <script>
    const datosUbicacion = {
      'Cundinamarca': {
        municipios: ['Soacha'],
        comunas: {
          'Soacha': ['Comuna 1 - Compartir', 'Comuna 2 - La Despensa', 'Comuna 3 - Ciudad Verde', 'Comuna 4 - Cazucá', 'Comuna 5 - San Mateo', 'Comuna 6 - San Humberto']
        }
      },
      'Bogotá D.C.': {
        municipios: ['Bogotá'],
        comunas: {
          'Bogotá': ['Usaquén', 'Chapinero', 'Santa Fe', 'San Cristóbal', 'Usme', 'Tunjuelito', 'Bosa', 'Kennedy', 'Fontibón', 'Engativá', 'Suba', 'Barrios Unidos', 'Teusaquillo', 'Los Mártires', 'Antonio Nariño', 'Puente Aranda', 'La Candelaria', 'Rafael Uribe Uribe', 'Ciudad Bolívar', 'Sumapaz']
        }
      }
    };

    document.getElementById('departamento').addEventListener('change', function () {
      const departamento = this.value;
      const municipioSelect = document.getElementById('municipio');
      const comunaSelect = document.getElementById('comuna');
      const labelComuna = document.getElementById('label-comuna');

      municipioSelect.innerHTML = '<option value="">Selecciona tu municipio</option>';
      comunaSelect.innerHTML = '<option value="">Primero selecciona un municipio</option>';

      if (departamento && datosUbicacion[departamento]) {
        datosUbicacion[departamento].municipios.forEach(municipio => {
          const option = document.createElement('option');
          option.value = municipio;
          option.textContent = municipio;
          municipioSelect.appendChild(option);
        });

        if (departamento === 'Bogotá D.C.') {
          labelComuna.textContent = 'Localidad';
        } else {
          labelComuna.textContent = 'Comuna';
        }
      }
    });

    document.getElementById('municipio').addEventListener('change', function () {
      const departamento = document.getElementById('departamento').value;
      const municipio = this.value;
      const comunaSelect = document.getElementById('comuna');

      comunaSelect.innerHTML = '<option value="">Selecciona una opción</option>';

      if (departamento && municipio && datosUbicacion[departamento].comunas[municipio]) {
        datosUbicacion[departamento].comunas[municipio].forEach(comuna => {
          const option = document.createElement('option');
          option.value = comuna;
          option.textContent = comuna;
          comunaSelect.appendChild(option);
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      const metodosPago = document.querySelectorAll('input[name="metodo_pago"]');
      const detallesPago = document.querySelectorAll('.pago-detalles');
      const opcionesPago = document.querySelectorAll('.metodo-pago-opcion');

      metodosPago.forEach(radio => {
        radio.addEventListener('change', function () {
          detallesPago.forEach(detalle => detalle.style.display = 'none');
          opcionesPago.forEach(opcion => opcion.classList.remove('seleccionado'));

          if (this.checked) {
            const idDetalle = 'detalles_' + this.value;
            const detalleSeleccionado = document.getElementById(idDetalle);
            if (detalleSeleccionado) {
              detalleSeleccionado.style.display = 'block';
              this.closest('.metodo-pago-opcion').classList.add('seleccionado');
            }
          }
        });
      });

      const radiosEnvio = document.querySelectorAll('input[name="pago_envio"]');
      const costoEnvioResumenDiv = document.getElementById('costo-envio-resumen-div');
      const totalValorResumen = document.getElementById('total-valor-resumen');
      const ivaValorResumen = document.getElementById('iva-valor-resumen');
      const baseLiquidaValor = document.getElementById('base-liquida-valor');
      const subtotal = Math.round(parseFloat('{{ total }}'));
      const costoEnvio = 10000;
      const tasaIVA = 0.19;

      function actualizarTotal() {
        const pagoAhora = document.querySelector('input[name="pago_envio"][value="ahora"]').checked;

        // Calcular IVA sobre el subtotal de productos (se suma adicional)
        const iva = Math.round(subtotal * tasaIVA);

        let totalFinal;
        if (pagoAhora) {
          costoEnvioResumenDiv.style.display = 'flex';
          totalFinal = subtotal + iva + costoEnvio;
        } else {
          costoEnvioResumenDiv.style.display = 'none';
          totalFinal = subtotal + iva;
        }

        baseLiquidaValor.textContent = '$' + subtotal.toLocaleString('es-CO');
        ivaValorResumen.textContent = '$' + iva.toLocaleString('es-CO');
        totalValorResumen.textContent = '$' + totalFinal.toLocaleString('es-CO');
      }

      radiosEnvio.forEach(radio => {
        radio.addEventListener('change', actualizarTotal);
      });

      actualizarTotal();
    });
  </script>
</body>